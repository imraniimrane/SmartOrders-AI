<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartOrders with Firebase</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB5B9IwPyKg8OMLkgen9pJrqUQCTFIq2t8",
      authDomain: "smartorders-ecee2.firebaseapp.com",
      projectId: "smartorders-ecee2",
      storageBucket: "smartorders-ecee2.appspot.com",
      messagingSenderId: "1000988624105",
      appId: "1:1000988624105:web:8a67c26609dc087b409c78",
      databaseURL: "https://smartorders-ecee2-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const authPage = document.getElementById("auth-page");
    const mainApp = document.getElementById("main-app");
    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");
    const loginUsernameInput = document.getElementById("login-username");
    const loginPasswordInput = document.getElementById("login-password");
    const signupUsernameInput = document.getElementById("signup-username");
    const signupPasswordInput = document.getElementById("signup-password");
    const rememberMe = document.getElementById("remember-me");
    const btnLogout = document.getElementById("btn-logout");
    const databaseSelect = document.getElementById("database-select");
    const dbTableBody = document.getElementById("db-table-body");
    const addDataForm = document.getElementById("add-data-form");
    const inputName = document.getElementById("input-name");
    const inputPhone = document.getElementById("input-phone");
    const inputProduct = document.getElementById("input-product");
    const inputQuantity = document.getElementById("input-quantity");
    const exportArea = document.getElementById("export-area");
    const btnExport = document.getElementById("btn-export");
    const btnClearDb = document.getElementById("btn-clear-db");
    const btnCreateDb = document.getElementById("btn-create-db");

    let currentUser = null;
    let currentDbName = "default";

    function saveToFirebase() {
      if (!currentUser) return;
      const data = JSON.parse(localStorage.getItem("smartorders_data") || "{}");
      set(ref(db, `users/${currentUser}`), data);
    }

    function loadFromFirebase(callback) {
      if (!currentUser) return;
      const userRef = ref(db, `users/${currentUser}`);
      get(userRef).then(snapshot => {
        if (snapshot.exists()) {
          localStorage.setItem("smartorders_data", JSON.stringify(snapshot.val()));
        }
        callback();
      });
    }

    function getUserData() {
      return JSON.parse(localStorage.getItem("smartorders_data") || "{}");
    }

    function saveUserData(data) {
      localStorage.setItem("smartorders_data", JSON.stringify(data));
      saveToFirebase();
    }

    function renderDatabases() {
      const userData = getUserData();
      databaseSelect.innerHTML = "";
      Object.keys(userData).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        databaseSelect.appendChild(opt);
      });
      databaseSelect.value = currentDbName;
      renderTable();
    }

    function renderTable() {
      const dbData = getUserData()[currentDbName] || [];
      dbTableBody.innerHTML = "";
      dbData.forEach((entry, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.name}</td>
          <td>${entry.phone}</td>
          <td>${entry.product}</td>
          <td>${entry.quantity}</td>
          <td><button data-idx="${i}" class="btn-delete">Delete</button></td>
        `;
        dbTableBody.appendChild(tr);
      });
      dbTableBody.querySelectorAll(".btn-delete").forEach(btn => {
        btn.onclick = () => {
          const data = getUserData();
          data[currentDbName].splice(btn.dataset.idx, 1);
          saveUserData(data);
          renderTable();
        };
      });
    }

    loginForm.onsubmit = e => {
      e.preventDefault();
      const u = loginUsernameInput.value;
      const p = loginPasswordInput.value;
      const users = JSON.parse(localStorage.getItem("smartorders_users") || "{}");
      if (users[u] && users[u] === p) {
        currentUser = u;
        if (rememberMe.checked) {
          localStorage.setItem("smartorders_remembered", JSON.stringify({ u, p }));
        }
        loadFromFirebase(() => {
          authPage.style.display = "none";
          mainApp.style.display = "block";
          renderDatabases();
        });
      } else {
        alert("Invalid credentials");
      }
    };

    signupForm.onsubmit = e => {
      e.preventDefault();
      const u = signupUsernameInput.value;
      const p = signupPasswordInput.value;
      const users = JSON.parse(localStorage.getItem("smartorders_users") || "{}");
      if (users[u]) return alert("Username taken");
      users[u] = p;
      localStorage.setItem("smartorders_users", JSON.stringify(users));
      alert("Account created");
    };

    btnLogout.onclick = () => {
      currentUser = null;
      authPage.style.display = "block";
      mainApp.style.display = "none";
    };

    databaseSelect.onchange = () => {
      currentDbName = databaseSelect.value;
      renderTable();
    };

    addDataForm.onsubmit = e => {
      e.preventDefault();
      const name = inputName.value.trim();
      const phone = inputPhone.value.trim();
      const product = inputProduct.value.trim();
      const quantity = parseInt(inputQuantity.value.trim());
      if (!name || !phone || !product || isNaN(quantity)) return alert("Invalid");
      const data = getUserData();
      if (!data[currentDbName]) data[currentDbName] = [];
      data[currentDbName].push({ name, phone, product, quantity });
      saveUserData(data);
      addDataForm.reset();
      renderTable();
    };

    btnCreateDb.onclick = () => {
      const name = prompt("New database name:");
      if (!name) return;
      const data = getUserData();
      if (data[name]) return alert("Exists");
      data[name] = [];
      saveUserData(data);
      currentDbName = name;
      renderDatabases();
    };

    btnExport.onclick = () => {
      const data = getUserData();
      exportArea.value = JSON.stringify(data[currentDbName], null, 2);
    };

    btnClearDb.onclick = () => {
      if (!confirm("Are you sure?")) return;
      const data = getUserData();
      data[currentDbName] = [];
      saveUserData(data);
      renderTable();
    };

    window.onload = () => {
      const rem = JSON.parse(localStorage.getItem("smartorders_remembered") || "null");
      if (rem) {
        loginUsernameInput.value = rem.u;
        loginPasswordInput.value = rem.p;
        rememberMe.checked = true;
      }
    };
  </script>
</head>
<body>
  <div id="auth-page">
    <form id="login-form">
      <h2>Login</h2>
      <input id="login-username" placeholder="Username" required />
      <input id="login-password" placeholder="Password" type="password" required />
      <label><input type="checkbox" id="remember-me" /> Remember Me</label>
      <button>Login</button>
    </form>
    <form id="signup-form">
      <h2>Signup</h2>
      <input id="signup-username" placeholder="Username" required />
      <input id="signup-password" placeholder="Password" type="password" required />
      <button>Sign Up</button>
    </form>
  </div>
  <div id="main-app" style="display:none">
    <button id="btn-logout">Logout</button>
    <select id="database-select"></select>
    <button id="btn-create-db">+ New DB</button>
    <form id="add-data-form">
      <input id="input-name" placeholder="Name" required />
      <input id="input-phone" placeholder="Phone" required />
      <input id="input-product" placeholder="Product" required />
      <input id="input-quantity" type="number" placeholder="Qty" required />
      <button>Add</button>
    </form>
    <table>
      <tbody id="db-table-body"></tbody>
    </table>
    <button id="btn-export">Export</button>
    <button id="btn-clear-db">Clear</button>
    <textarea id="export-area" style="width:100%; height:100px;"></textarea>
  </div>
</body>
</html>
